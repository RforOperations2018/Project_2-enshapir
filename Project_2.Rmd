---
title: "Project 2"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

Sidebar {.sidebar}
=====================================

```{r setup, include=FALSE}
library(shiny)
library(flexdashboard)
library(tidyverse)
library(jsonlite)
library(plotly)
library(DT)
library(shinythemes)
library(httr)
library(htmltools)
library(sf)
library(rgdal)
library(leaflet)
library(leaflet.extras)


# #to install pacakgs while working on school computers
# install.packages(c("shiny", "flexdashboard", "tidyverse", "jsonlite", "plotly", "DT", "shinythemes", "httr", "htmltools", "sf", "rgdal", "leaflet", "leaflet.extras"), dependencies = TRUE)



```

```{r include=FALSE}
#API Documentation: https://dev.socrata.com/foundry/data.cityofnewyork.us/qiz3-axqb

#Defining API functions from class
ckanGeoSQL <- function(url) {
  # Make the Request
  r <- RETRY("GET", URLencode(url))
  # Extract Content
  c <- content(r, "text")
  # Basic gsub to make NA's consistent with R
  json <- gsub('NaN', 'NA', c, perl = TRUE)
  # Create Dataframe
  readOGR(json)
}

ckanSQL <- function(url) {
  # Make the Request
  r <- RETRY("GET", URLencode(url))
  # Extract Content
  c <- content(r, "text")
  # Basic gsub to make NA's consistent with R
  json <- gsub('NaN', 'NA', c, perl = TRUE)
  # Create Dataframe
  data.frame(fromJSON(json))
}


 # Unique values for Resource Field
 ckanUniques <- function(id, field) {
   url <- paste0("https://data.cityofnewyork.us/resource/qiz3-axqb.geojson?$select=lower(",field,")&$group=",field,"&$having=",field," IS NOT NULL")
   print(url)
   c(ckanSQL(URLencode(url)))
 }
 
test1 <- ckanUniques(field = "vehicle_type_code1")

test2 <- ckanUniques(field = "contributing_factor_vehicle_1")


url <- "https://data.cityofnewyork.us/resource/qiz3-axqb.geojson?$limit=10000"
accidents.load <- ckanGeoSQL(url = url)
accidents.load$date <- as.Date(accidents.load$date)
accidents.load$vehicle_type_code1 <- tolower(accidents.load$vehicle_type_code1)

# url2 <- "https://data.cityofnewyork.us/resource/qiz3-axqb.geojson?$select=lower(vehicle_type_code1)&$group=vehicle_type_code1&$having=vehicle_type_code1= IS NOT NULL"
# accidents.uniq <- ckanSQL(url = url2)

```


```{r}
output$CarType <- renderUI({
    selectInput(inputId = "factorType1",
                   label = "Step 1: Choose a Contributing Factor",
                   choices = ckanUniques(field = "contributing_factor_vehicle_1")$features.properties$lower_contributing_factor_vehicle_1 ,
                   multiple = TRUE,
                   selectize = TRUE,
                   selected = ckanUniques(field = "contributing_factor_vehicle_1")$features.properties$lower_contributing_factor_vehicle_1[1]
                   )
    })
uiOutput("CarType")


AccidInput <- reactive({
    url <- paste0("https://data.cityofnewyork.us/resource/qiz3-axqb.geojson?$where=lower(contributing_factor_vehicle_1) in('",noquote(paste(input$factorType1, collapse = "', '")),"')")
    print(url)
    print(noquote(paste(input$factorType1, collapse = "', '")))
    accidents.server1 <- ckanGeoSQL(url = url)
    accidents.server1$date <- as.Date(accidents.server1$date)
  return(accidents.server1)
  })

output$dateRange <- renderUI({
    dateRangeInput(inputId = "dateRange1",
                   label = "Step 2: Pick a Date Range",
                   start = min(AccidInput()$date, na.rm = TRUE), 
                   end = max(AccidInput()$date, na.rm = TRUE),
                   min = min(AccidInput()$date, na.rm = TRUE),
                   max = max(AccidInput()$date, na.rm = TRUE)
                   )
    })
uiOutput("dateRange")





```


```{r include=FALSE}
 swInput <- reactive({
    # Race Filter
    if (length(input$SelectedRace) > 0 ) {
      RaceAgeGender.server <- subset(RaceAgeGender, Race %in% input$SelectedRace)
    }
    
    return( RaceAgeGender.server)
  })
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}





```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{rinclude=FALSE}
value box, nunber of poeple killed to date
crashes aggregated by hour


```

Map
=====================================

Row 
-------------------------------------


```{r }
output$mymap <- renderLeaflet({
  leaflet()%>% 
  setView(-74.4493175, 29.356908, zoom = 4) %>% #set the view of the map
 # addCircles(data = test1, lng = ~as.numeric(as.character(longitude)), lat = ~as.numeric(as.character(latitude)), weight = 1, color ='#da0feb') %>% #added the circles over large
addHeatmap(data = accidents.load, lng = ~as.numeric(as.character(longitude)), lat = ~as.numeric(as.character(latitude)), radius = 8)
  })
leafletOutput("mymap")
```

